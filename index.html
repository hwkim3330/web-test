<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VelocityDRIVE-SP Manager</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #F5F5F7;
      --card: rgba(255,255,255,0.8);
      --border: rgba(0,0,0,0.06);
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --blue: #007AFF;
      --green: #34C759;
      --red: #FF3B30;
      --orange: #FF9500;
      --radius: 20px;
      --radius-sm: 12px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #007AFF, #5856D6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .logo-icon svg { width: 22px; height: 22px; color: white; }
    .logo-text h1 { font-size: 14px; font-weight: 700; color: var(--text); }
    .logo-text p { font-size: 10px; color: var(--text-secondary); font-weight: 500; }

    .nav-section { margin-bottom: 24px; }
    .nav-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 16px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .nav-item:hover { background: rgba(0,0,0,0.04); color: var(--text); }
    .nav-item.active {
      background: white;
      color: var(--blue);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .nav-item svg { width: 18px; height: 18px; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; color: var(--blue); }

    .device-card {
      margin-top: auto;
      background: white;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .device-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .device-label { font-size: 10px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
      position: relative;
    }

    .status-dot.connected {
      background: var(--green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(52,199,89,0.4); }
      50% { box-shadow: 0 0 0 6px rgba(52,199,89,0); }
    }

    .device-info { display: flex; align-items: center; gap: 12px; }
    .device-icon {
      width: 36px;
      height: 36px;
      background: var(--bg);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .device-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
    .device-name { font-size: 12px; font-weight: 600; }
    .device-type { font-size: 10px; color: var(--text-secondary); }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: 260px;
      padding: 24px 32px;
      overflow-y: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .header h2 { font-size: 24px; font-weight: 700; }

    .header-actions { display: flex; gap: 12px; align-items: center; }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .search-box input {
      border: none;
      outline: none;
      font-size: 13px;
      width: 160px;
      background: transparent;
    }

    .search-box svg { width: 16px; height: 16px; color: var(--text-secondary); }

    /* Status Banner */
    .status-banner {
      background: white;
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .status-banner.connected { border-color: rgba(52,199,89,0.3); }
    .status-banner.error { border-color: rgba(255,59,48,0.3); background: #FFF5F5; }

    .status-glow {
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
      pointer-events: none;
    }

    .status-banner.connected .status-glow { background: var(--green); }
    .status-banner.error .status-glow { background: var(--red); }
    .status-banner:not(.connected):not(.error) .status-glow { background: var(--text-secondary); }

    .status-content { position: relative; z-index: 1; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .status-badge.success { color: var(--green); }
    .status-badge.error { color: var(--red); }
    .status-badge.idle { color: var(--text-secondary); }

    .status-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .status-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.6; max-width: 500px; }

    .status-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--blue);
      color: white;
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,122,255,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { background: var(--bg); }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    /* Grid Layout */
    .grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .grid-3 { grid-template-columns: repeat(2, 1fr); }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg { width: 16px; height: 16px; color: var(--blue); }

    /* Metric Cards */
    .metric-card {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .metric-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .metric-icon.blue { background: rgba(0,122,255,0.1); color: var(--blue); }
    .metric-icon.green { background: rgba(52,199,89,0.1); color: var(--green); }
    .metric-icon.orange { background: rgba(255,149,0,0.1); color: var(--orange); }

    .metric-icon svg { width: 22px; height: 22px; }

    .metric-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .metric-value { font-size: 28px; font-weight: 700; }
    .metric-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

    /* Port Grid */
    .port-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .port-btn {
      padding: 16px 8px;
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .port-btn:hover { border-color: rgba(0,122,255,0.3); color: var(--text); }
    .port-btn.selected { background: rgba(0,122,255,0.1); border-color: var(--blue); color: var(--blue); }

    .port-presets {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .preset-btn {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover { background: white; color: var(--text); }

    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }

    .form-select, .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
      outline: none;
      transition: all 0.2s;
    }

    .form-select:focus, .form-input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }

    /* Terminal */
    .terminal {
      background: #1C1C1E;
      border-radius: var(--radius);
      padding: 20px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      color: #98989D;
      height: 300px;
      overflow-y: auto;
    }

    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .terminal-dots { display: flex; gap: 6px; }
    .terminal-dot { width: 10px; height: 10px; border-radius: 50%; }
    .terminal-dot.red { background: #FF5F57; }
    .terminal-dot.yellow { background: #FEBC2E; }
    .terminal-dot.green { background: #28C840; }

    .terminal-title { font-size: 11px; font-weight: 600; color: #636366; }

    .log-line { margin-bottom: 6px; line-height: 1.5; }
    .log-time { color: #48484A; margin-right: 12px; }
    .log-info { color: #64D2FF; }
    .log-success { color: #30D158; }
    .log-error { color: #FF453A; }
    .log-tx { color: #FFD60A; }
    .log-rx { color: #32D74B; }
    .log-debug { color: #BF5AF2; }

    .terminal-prompt {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .prompt-user { color: #30D158; font-weight: 600; }
    .prompt-cursor { width: 8px; height: 16px; background: #636366; animation: blink 1s infinite; }

    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    /* Animations */
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

    /* Quick presets row */
    .presets-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .action-row .btn { flex: 1; justify-content: center; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
        </div>
        <div class="logo-text">
          <h1>VelocityDRIVE</h1>
          <p>TSN Manager</p>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-title">Control</div>
        <div class="nav-item active" onclick="showTab('dashboard')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard
        </div>
        <div class="nav-item" onclick="showTab('cbs')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          CBS Config
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-title">System</div>
        <div class="nav-item" onclick="showTab('logs')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          Logs
        </div>
      </div>

      <div class="device-card">
        <div class="device-header">
          <span class="device-label">Device</span>
          <span class="status-dot" id="sidebarDot"></span>
        </div>
        <div class="device-info">
          <div class="device-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 9h6v6H9z"/></svg>
          </div>
          <div>
            <div class="device-name" id="deviceName">Not Connected</div>
            <div class="device-type">VelocityDRIVE-SP</div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="header">
        <h2 id="pageTitle">Dashboard</h2>
        <div class="header-actions">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" placeholder="Search...">
          </div>
        </div>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboardTab" class="fade-in">
        <!-- Status Banner -->
        <div class="status-banner" id="statusBanner">
          <div class="status-glow"></div>
          <div class="status-content">
            <div class="status-badge idle" id="statusBadge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
              <span id="statusText">Disconnected</span>
            </div>
            <h3 class="status-title" id="statusTitle">Connect to Device</h3>
            <p class="status-desc" id="statusDesc">Click the connect button to establish a serial connection with your VelocityDRIVE-SP switch.</p>
            <div class="status-actions">
              <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                Connect
              </button>
              <button class="btn btn-secondary" onclick="sendPing()" id="pingBtn" disabled>Ping Device</button>
            </div>
          </div>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-3" style="margin-bottom: 24px;">
          <div class="metric-card">
            <div class="metric-icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <div class="metric-label">Connection</div>
            <div class="metric-value" id="connMetric">--</div>
            <div class="metric-sub" id="connSub">Not connected</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
            </div>
            <div class="metric-label">Firmware</div>
            <div class="metric-value" id="fwMetric">--</div>
            <div class="metric-sub" id="fwSub">Unknown</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon orange">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
            </div>
            <div class="metric-label">Uptime</div>
            <div class="metric-value" id="uptimeMetric">--</div>
            <div class="metric-sub">Since boot</div>
          </div>
        </div>

        <!-- Terminal -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,17 10,11 4,5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
              Communication Log
            </div>
            <button class="btn btn-secondary" onclick="clearLog()" style="padding: 6px 12px; font-size: 11px;">Clear</button>
          </div>
          <div class="terminal" id="logArea">
            <div class="terminal-header">
              <div class="terminal-dots">
                <div class="terminal-dot red"></div>
                <div class="terminal-dot yellow"></div>
                <div class="terminal-dot green"></div>
              </div>
              <div class="terminal-title">MUP1/CoAP Output</div>
            </div>
            <div id="logContent"></div>
            <div class="terminal-prompt">
              <span class="prompt-user">admin@velocitysp:~$</span>
              <span class="prompt-cursor"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- CBS Config Tab -->
      <div id="cbsTab" style="display: none;" class="fade-in">
        <div class="grid grid-2">
          <!-- Port Selection -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                Port Selection
              </div>
            </div>
            <div class="port-grid" id="portGrid"></div>
            <div class="port-presets">
              <button class="preset-btn" onclick="selectPorts([1,2,3,4])">1-4</button>
              <button class="preset-btn" onclick="selectPorts([5,6,7,8])">5-8</button>
              <button class="preset-btn" onclick="selectPorts([9,10,11,12])">9-12</button>
              <button class="preset-btn" onclick="selectAllPorts()">All</button>
              <button class="preset-btn" onclick="clearPorts()">Clear</button>
            </div>
          </div>

          <!-- CBS Settings -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/><path d="M20.66 7l-5.2 3m-6.92 4l-5.2 3"/><path d="M3.34 7l5.2 3m6.92 4l5.2 3"/></svg>
                CBS Parameters
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Traffic Class</label>
                <select class="form-select" id="trafficClass">
                  <option value="7">TC 7 - Network Control</option>
                  <option value="6">TC 6 - Voice</option>
                  <option value="5">TC 5 - Video</option>
                  <option value="4">TC 4 - Controlled Load</option>
                  <option value="3">TC 3 - Excellent Effort</option>
                  <option value="2">TC 2 - Spare</option>
                  <option value="1">TC 1 - Background</option>
                  <option value="0">TC 0 - Best Effort</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Idle Slope (kbps)</label>
                <input type="number" class="form-input" id="idleSlope" value="100000" min="0" max="1000000" step="1000">
              </div>
            </div>
            <div class="presets-row">
              <button class="preset-btn" onclick="setIdleSlope(10000)">10 Mbps</button>
              <button class="preset-btn" onclick="setIdleSlope(50000)">50 Mbps</button>
              <button class="preset-btn" onclick="setIdleSlope(100000)">100 Mbps</button>
              <button class="preset-btn" onclick="setIdleSlope(250000)">250 Mbps</button>
              <button class="preset-btn" onclick="setIdleSlope(500000)">500 Mbps</button>
            </div>
            <div class="action-row">
              <button class="btn btn-primary" id="applyBtn" onclick="applyCBS()" disabled>Apply CBS</button>
              <button class="btn btn-danger" id="clearCbsBtn" onclick="clearCBS()" disabled>Clear CBS</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logsTab" style="display: none;" class="fade-in">
        <div class="card" style="height: calc(100vh - 160px);">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4,17 10,11 4,5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
              Full System Logs
            </div>
            <button class="btn btn-secondary" onclick="clearLog()" style="padding: 6px 12px; font-size: 11px;">Clear</button>
          </div>
          <div class="terminal" id="fullLogArea" style="height: calc(100% - 60px);">
            <div class="terminal-header">
              <div class="terminal-dots">
                <div class="terminal-dot red"></div>
                <div class="terminal-dot yellow"></div>
                <div class="terminal-dot green"></div>
              </div>
              <div class="terminal-title">LIVE</div>
            </div>
            <div id="fullLogContent"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
// =====================================================================
// YANG SID Definitions
// =====================================================================
const SID = { TRAFFIC_CLASS_SHAPERS: 8051, TRAFFIC_CLASS: 8052, CREDIT_BASED: 8053, IDLE_SLOPE: 8054 };
const DELTA = { TC: 1, CB: 2, IS: 1 };

// =====================================================================
// MUP1 Protocol
// =====================================================================
const MUP1 = {
  SOF: 0x3e, EOF: 0x3c, ESC: 0x5c, ESC_00: 0x30, ESC_FF: 0x46,

  calcChecksum(data) {
    let sum = 0;
    for (let i = 0; i < data.length; i += 2) {
      sum += (data[i] << 8) | (data[i + 1] || 0);
    }
    sum = ((sum >> 16) + (sum & 0xffff));
    sum = ((sum >> 16) + (sum & 0xffff));
    return ((~sum) & 0xffff).toString(16).padStart(4, '0');
  },

  encode(type, payload) {
    const rawFrame = [this.SOF, type.charCodeAt(0), ...payload, this.EOF];
    if (payload.length % 2 === 0) rawFrame.push(this.EOF);
    const checksum = this.calcChecksum(rawFrame);

    const frame = [this.SOF, type.charCodeAt(0)];
    for (const b of payload) {
      if (b === this.SOF || b === this.EOF || b === this.ESC) frame.push(this.ESC, b);
      else if (b === 0x00) frame.push(this.ESC, this.ESC_00);
      else if (b === 0xff) frame.push(this.ESC, this.ESC_FF);
      else frame.push(b);
    }
    frame.push(this.EOF);
    if (payload.length % 2 === 0) frame.push(this.EOF);
    for (const c of checksum) frame.push(c.charCodeAt(0));
    return new Uint8Array(frame);
  },

  createPing() { return this.encode('p', []); },

  state: 'IDLE', buffer: [],
  reset() { this.state = 'IDLE'; this.buffer = []; },

  parse(bytes) {
    const frames = [];
    for (const b of bytes) {
      switch (this.state) {
        case 'IDLE': if (b === this.SOF) { this.buffer = []; this.state = 'DATA'; } break;
        case 'DATA':
          if (b === this.ESC) this.state = 'ESCAPE';
          else if (b === this.EOF) this.state = 'EOF1';
          else this.buffer.push(b);
          break;
        case 'ESCAPE':
          this.buffer.push(b === this.ESC_00 ? 0x00 : b === this.ESC_FF ? 0xff : b);
          this.state = 'DATA';
          break;
        case 'EOF1':
          if (b === this.EOF) this.state = 'CHECKSUM';
          else if (/[0-9A-Fa-f]/.test(String.fromCharCode(b))) { this.state = 'CHECKSUM'; this.buffer.push(b); }
          else this.state = 'IDLE';
          break;
        case 'CHECKSUM':
          this.buffer.push(b);
          if (this.buffer.length >= 4) {
            frames.push({ type: String.fromCharCode(this.buffer[0]), data: new Uint8Array(this.buffer.slice(1, -4)) });
            this.state = 'IDLE'; this.buffer = [];
          }
          break;
      }
    }
    return frames;
  }
};

// =====================================================================
// CoAP Protocol
// =====================================================================
const CoAP = {
  CODE_IPATCH: 7, FORMAT_YANG_INSTANCES_CBOR: 142,
  msgId: Math.floor(Math.random() * 65536),

  buildFrame(method, path, payload = null) {
    const frame = [0x41, method, (this.msgId >> 8) & 0xff, this.msgId++ & 0xff, 0x00];
    let lastOpt = 0;
    for (const p of path.split('/').filter(x => x)) {
      frame.push(((11 - lastOpt) << 4) | p.length);
      for (let i = 0; i < p.length; i++) frame.push(p.charCodeAt(i));
      lastOpt = 11;
    }
    if (payload) { frame.push(((12 - lastOpt) << 4) | 1, this.FORMAT_YANG_INSTANCES_CBOR); lastOpt = 12; }
    frame.push(((23 - lastOpt) << 4) | 1, 0x04);
    if (payload?.length > 0) { frame.push(0xff, ...payload); }
    return new Uint8Array(frame);
  },

  parseResponse(data) {
    if (data.length < 4) return null;
    const code = data[1];
    return { codeClass: (code >> 5) & 0x7, codeDetail: code & 0x1f };
  }
};

// =====================================================================
// CBOR Encoder
// =====================================================================
function encodeCBOR(value) {
  const result = [];
  function encodeInt(v) {
    if (v < 24) result.push(v);
    else if (v < 256) result.push(0x18, v);
    else if (v < 65536) result.push(0x19, (v >> 8) & 0xff, v & 0xff);
    else result.push(0x1a, (v >> 24) & 0xff, (v >> 16) & 0xff, (v >> 8) & 0xff, v & 0xff);
  }
  function encode(v) {
    if (v === null || v === undefined) { result.push(0xf6); return; }
    if (typeof v === 'number' && Number.isInteger(v) && v >= 0) { encodeInt(v); return; }
    if (typeof v === 'string') {
      const bytes = new TextEncoder().encode(v);
      result.push(bytes.length < 24 ? 0x60 | bytes.length : 0x78, bytes.length);
      result.push(...bytes);
      return;
    }
    if (Array.isArray(v)) { result.push(0x80 | v.length); v.forEach(encode); return; }
    if (typeof v === 'object') {
      const keys = Object.keys(v).map(k => parseInt(k)).sort((a, b) => a - b);
      result.push(0xa0 | keys.length);
      keys.forEach(k => { encodeInt(k); encode(v[k]); });
    }
  }
  encode(value);
  return result;
}

function buildCBSPayload(portName, trafficClass, idleSlope) {
  const iid = [0x82, 0x19, (SID.TRAFFIC_CLASS_SHAPERS >> 8) & 0xff, SID.TRAFFIC_CLASS_SHAPERS & 0xff];
  const nameBytes = new TextEncoder().encode(portName);
  iid.push(0x60 | nameBytes.length, ...nameBytes);
  const entry = { [DELTA.TC]: trafficClass, [DELTA.CB]: { [DELTA.IS]: idleSlope } };
  return new Uint8Array([0xa1, ...iid, ...encodeCBOR([entry])]);
}

function buildCBSClearPayload(portName) {
  const result = [0xa1, 0x82, 0x19, (SID.TRAFFIC_CLASS_SHAPERS >> 8) & 0xff, SID.TRAFFIC_CLASS_SHAPERS & 0xff];
  const nameBytes = new TextEncoder().encode(portName);
  result.push(0x60 | nameBytes.length, ...nameBytes, 0xf6);
  return new Uint8Array(result);
}

// =====================================================================
// Application State
// =====================================================================
let port = null, writer = null, reader = null, connected = false;
let selectedPorts = new Set();
let deviceInfo = { build: null, uptime: null };

// =====================================================================
// UI Functions
// =====================================================================
function showTab(tab) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.nav-item').classList.add('active');

  document.getElementById('dashboardTab').style.display = tab === 'dashboard' ? 'block' : 'none';
  document.getElementById('cbsTab').style.display = tab === 'cbs' ? 'block' : 'none';
  document.getElementById('logsTab').style.display = tab === 'logs' ? 'block' : 'none';

  const titles = { dashboard: 'Dashboard', cbs: 'CBS Configuration', logs: 'System Logs' };
  document.getElementById('pageTitle').textContent = titles[tab] || 'Dashboard';
}

function initPortGrid() {
  const grid = document.getElementById('portGrid');
  for (let i = 1; i <= 12; i++) {
    const btn = document.createElement('button');
    btn.className = 'port-btn';
    btn.textContent = i;
    btn.onclick = () => {
      selectedPorts.has(i) ? selectedPorts.delete(i) : selectedPorts.add(i);
      btn.classList.toggle('selected');
    };
    grid.appendChild(btn);
  }
}

function selectPorts(ports) { clearPorts(); document.querySelectorAll('.port-btn').forEach((btn, i) => { if (ports.includes(i + 1)) { selectedPorts.add(i + 1); btn.classList.add('selected'); } }); }
function selectAllPorts() { selectPorts([1,2,3,4,5,6,7,8,9,10,11,12]); }
function clearPorts() { selectedPorts.clear(); document.querySelectorAll('.port-btn').forEach(b => b.classList.remove('selected')); }
function setIdleSlope(v) { document.getElementById('idleSlope').value = v; }

function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="log-time">${time}</span><span class="log-${type}">${msg}</span>`;

  ['logContent', 'fullLogContent'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.appendChild(line.cloneNode(true)); el.parentElement.scrollTop = el.parentElement.scrollHeight; }
  });
}

function logHex(prefix, data, type = 'info') {
  const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
  log(`${prefix}: ${hex.slice(0, 60)}${hex.length > 60 ? '...' : ''} (${data.length}B)`, type);
}

function clearLog() { ['logContent', 'fullLogContent'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; }); }

function updateStatus(state) {
  connected = state;
  const banner = document.getElementById('statusBanner');
  const badge = document.getElementById('statusBadge');
  const title = document.getElementById('statusTitle');
  const desc = document.getElementById('statusDesc');
  const btn = document.getElementById('connectBtn');
  const dot = document.getElementById('sidebarDot');
  const devName = document.getElementById('deviceName');

  banner.className = 'status-banner ' + (state ? 'connected' : '');
  badge.className = 'status-badge ' + (state ? 'success' : 'idle');
  badge.querySelector('span').textContent = state ? 'Connected' : 'Disconnected';
  title.textContent = state ? 'System Operational' : 'Connect to Device';
  desc.textContent = state
    ? `Connected to VelocityDRIVE-SP. ${deviceInfo.build || ''} running for ${deviceInfo.uptime || '--'}s.`
    : 'Click the connect button to establish a serial connection with your VelocityDRIVE-SP switch.';
  btn.innerHTML = state
    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg> Disconnect'
    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Connect';

  dot.classList.toggle('connected', state);
  devName.textContent = state ? 'LAN9662' : 'Not Connected';

  document.getElementById('pingBtn').disabled = !state;
  document.getElementById('applyBtn').disabled = !state;
  document.getElementById('clearCbsBtn').disabled = !state;

  document.getElementById('connMetric').textContent = state ? 'Online' : '--';
  document.getElementById('connSub').textContent = state ? 'Serial connected' : 'Not connected';
}

// =====================================================================
// Serial Communication
// =====================================================================
async function toggleConnection() { connected ? await disconnect() : await connect(); }

async function connect() {
  try {
    log('Requesting serial port...', 'info');
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200, dataBits: 8, stopBits: 1, parity: 'none', flowControl: 'none' });
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    updateStatus(true);
    log('Serial port connected', 'success');
    MUP1.reset();
    startReadLoop();
    setTimeout(sendPing, 500);
  } catch (e) { log(`Connection failed: ${e.message}`, 'error'); }
}

async function disconnect() {
  try {
    connected = false;
    if (reader) { await reader.cancel().catch(() => {}); reader.releaseLock(); }
    if (writer) { writer.releaseLock(); }
    if (port) { await port.close().catch(() => {}); }
  } catch (e) {}
  port = null; writer = null; reader = null;
  updateStatus(false);
  log('Disconnected', 'info');
}

async function startReadLoop() {
  try {
    while (connected) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value?.length > 0) {
        logHex('RX', value, 'rx');
        MUP1.parse(value).forEach(handleFrame);
      }
    }
  } catch (e) { if (connected) log(`Read error: ${e.message}`, 'error'); }
}

function handleFrame(frame) {
  if (frame.type === 'P') {
    const text = new TextDecoder().decode(frame.data);
    const parts = text.split(' ');
    deviceInfo.build = parts[0] || 'Unknown';
    deviceInfo.uptime = parts[1] || '--';
    log(`PONG: ${deviceInfo.build}, uptime=${deviceInfo.uptime}s`, 'success');

    document.getElementById('fwMetric').textContent = deviceInfo.build.replace('VelocitySP-', '');
    document.getElementById('fwSub').textContent = 'VelocityDRIVE-SP';
    document.getElementById('uptimeMetric').textContent = deviceInfo.uptime + 's';
    updateStatus(true);
  } else if (frame.type === 'C') {
    const resp = CoAP.parseResponse(frame.data);
    if (resp) log(`CoAP ${resp.codeClass}.${resp.codeDetail.toString().padStart(2,'0')} ${resp.codeClass === 2 ? 'OK' : 'Error'}`, resp.codeClass === 2 ? 'success' : 'error');
  } else if (frame.type === 'T') {
    log(`TRACE: ${new TextDecoder().decode(frame.data)}`, 'debug');
  }
}

async function send(data) {
  if (!writer) { log('Not connected', 'error'); return false; }
  try { await writer.write(data); logHex('TX', data, 'tx'); return true; }
  catch (e) { log(`Send error: ${e.message}`, 'error'); return false; }
}

async function sendPing() { log('Sending ping...', 'info'); await send(MUP1.createPing()); }

async function applyCBS() {
  if (selectedPorts.size === 0) { log('Select ports first', 'error'); return; }
  const tc = parseInt(document.getElementById('trafficClass').value);
  const idleSlope = parseInt(document.getElementById('idleSlope').value);
  const ports = Array.from(selectedPorts).sort((a, b) => a - b);
  log(`Applying CBS: ports=[${ports}], TC${tc}, ${idleSlope}kbps`, 'info');

  for (const p of ports) {
    const payload = buildCBSPayload(String(p), tc, idleSlope);
    log(`Port ${p} CBOR: ${Array.from(payload).map(b => b.toString(16).padStart(2,'0')).join(' ')}`, 'debug');
    await send(MUP1.encode('c', CoAP.buildFrame(CoAP.CODE_IPATCH, 'c', payload)));
    await new Promise(r => setTimeout(r, 400));
  }
  log('CBS configuration applied', 'success');
}

async function clearCBS() {
  if (selectedPorts.size === 0) { log('Select ports first', 'error'); return; }
  const ports = Array.from(selectedPorts).sort((a, b) => a - b);
  log(`Clearing CBS: ports=[${ports}]`, 'info');

  for (const p of ports) {
    await send(MUP1.encode('c', CoAP.buildFrame(CoAP.CODE_IPATCH, 'c', buildCBSClearPayload(String(p)))));
    await new Promise(r => setTimeout(r, 400));
  }
  log('CBS configuration cleared', 'success');
}

// =====================================================================
// Init
// =====================================================================
if (!('serial' in navigator)) {
  document.getElementById('connectBtn').disabled = true;
  log('Web Serial API not supported. Use Chrome 89+ or Edge 89+.', 'error');
}
initPortGrid();
log('VelocityDRIVE-SP Manager initialized', 'info');
log('Protocol: Web Serial → MUP1 → CoAP → CBOR (CORECONF)', 'info');
</script>
</body>
</html>
